<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Просмотр заказа</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #result { margin-top: 20px; white-space: pre-wrap; }
        .section { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Работа с заказами</h1>

    <!-- Поиск одного заказа -->
    <div class="section">
        <h2>Получить заказ по ID</h2>
        <input type="text" id="orderId" placeholder="b563feb7b2b84b6test">
        <button onclick="fetchOrder()">Получить</button>
    </div>

    <!-- Массовая отправка заказов -->
    <div class="section">
        <h2>Послать заказы</h2>
        <input type="number" id="orderCount" placeholder="Введите количество">
        <button onclick="sendOrders()">Послать заказы</button>
    </div>

    <div id="result"></div>

    <script>
        async function fetchOrder() {
            const orderId = document.getElementById('orderId').value;
            const apiUrl = `http://localhost:8081/order/${orderId}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Заказ не найден');
                const data = await response.json();
                document.getElementById('result').innerText = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('result').innerText = `Ошибка: ${error.message}`;
            }
        }

        async function sendOrders() {
            const count = document.getElementById('orderCount').value;
            const apiUrl = `http://localhost:8081/order/generate?count=${count}`;
            const resultDiv = document.getElementById('result');
            resultDiv.innerText = "Загрузка заказов...\n";

            try {
                // Получаем массив заказов
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Не удалось получить заказы');
                const orders = await response.json();

                let failed = [];
                for (const order of orders) {
                    try {
                        const res = await fetch("http://localhost:8081/order/", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(order)
                        });

                        const data = await res.json();

                        if (!res.ok || data.message !== "Order sent to Kafka successfully") {
                            failed.push(order.order_uid);
                        }
                    } catch (err) {
                        failed.push(order.order_uid);
                    }
                }

                if (failed.length === 0) {
                    resultDiv.innerText = "✅ Все заказы успешно отправлены в Kafka!";
                } else {
                    resultDiv.innerText = `⚠️ Ошибка при отправке заказов: ${failed.join(", ")}`;
                }
            } catch (error) {
                resultDiv.innerText = `Ошибка: ${error.message}`;
            }
        }
    </script>
</body>
</html>
